// tests/debug.test.ts
import { describe, it, expect, beforeEach } from 'vitest'
import { vi } from 'vitest'
import { apiClient } from '@/tests/lib/api/client'
import { printOutput } from '@/tests/helpers/debug.ts'

describe('éªŒè¯ process.stdout.write', () => {
    beforeEach(() => {
        printOutput('ğŸ”µ beforeEach - æ¯ä¸ªæµ‹è¯•å‰æ‰§è¡Œ')
    })

    it('æµ‹è¯•1: æ­£å¸¸æ—¥å¿—', () => {
        printOutput("ğŸŸ¢ æµ‹è¯•1å¼€å§‹")
        const data = { name: 'test', value: 42 }
        printOutput(`æ•°æ®: ${JSON.stringify(data)}`)
        console.table([{ id: 1, name: 'Alice' }, { id: 2, name: 'Bob' }])
        expect(true).toBe(true)
        printOutput('ğŸŸ¢ æµ‹è¯•1ç»“æŸ')
    })

    it('æµ‹è¯•2: å¤±è´¥æ—¶çœ‹æ—¥å¿—', async () => {
        printOutput('ğŸŸ¡ æµ‹è¯•2å¼€å§‹ - æ¨¡æ‹Ÿå¼‚æ­¥')

        // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        await new Promise(resolve => setTimeout(resolve, 100))

        printOutput('ğŸŸ¡ å¼‚æ­¥æ“ä½œå®Œæˆ')
        printOutput('è¿™æ˜¯ä¸€ä¸ªè­¦å‘Š')
        printOutput('è¿™æ˜¯ä¸€ä¸ªé”™è¯¯ï¼ˆä½†ä¸æ˜¯æµ‹è¯•å¤±è´¥ï¼‰')

        expect(2 + 2).toBe(4)
    })

    it('æµ‹è¯•3: æ•…æ„å¤±è´¥æŸ¥çœ‹å®Œæ•´è¾“å‡º', () => {
        printOutput('ğŸ”´ æµ‹è¯•3å¼€å§‹ - è¿™ä¸ªä¼šå¤±è´¥')
        printOutput('å¤±è´¥å‰çš„æ—¥å¿—åº”è¯¥èƒ½çœ‹åˆ°')

        // æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œè®©æµ‹è¯•é€šè¿‡ï¼Œå–æ¶ˆæ³¨é‡Šè®©æµ‹è¯•å¤±è´¥
        // expect(true).toBe(false)

        printOutput('è¿™è¡Œåœ¨æœŸæœ›å¤±è´¥åä¸ä¼šæ‰§è¡Œ')
    })

    it('è°ƒè¯•ï¼šæŸ¥çœ‹ apiClient.get çš„è¡Œä¸º', async () => {
        // 1. æ¨¡æ‹Ÿä¸€ä¸ªæ°¸è¿œä¸ä¼šå®Œæˆçš„ fetch
        global.fetch = vi.fn().mockReturnValue(new Promise(() => {
            // ç©ºçš„ executorï¼Œæ°¸è¿œä¸ä¼šè°ƒç”¨ resolve/reject
        }))
    
        // 2. è°ƒç”¨å¹¶è§‚å¯Ÿ
        printOutput('=== å¼€å§‹æµ‹è¯• ===')
        const startTime = Date.now()
    
        const apiPromise = apiClient.get('/users', { timeout: 100 })
        
        printOutput('ç«‹å³çŠ¶æ€:', {
            isPromise: apiPromise instanceof Promise,
        })
    
        // 3. ç›‘å¬çŠ¶æ€å˜åŒ–
        const resultPromise = apiPromise
            .then(result => {
                const elapsed = Date.now() - startTime
                printOutput(`âœ… ${elapsed}ms åæˆåŠŸ:`, result)
                return { type: 'success', result }
            })
            .catch(error => {
                const elapsed = Date.now() - startTime
                printOutput(`âŒ ${elapsed}ms åå¤±è´¥:`, {
                    message: error.message,
                    constructor: error.constructor.name,
                })
                return { type: 'error', error }
            })
    
        // 4. ç­‰å¾…ç»“æœï¼ˆç»™è¶³å¤Ÿæ—¶é—´ï¼Œä½†ä¸è¶…è¿‡æµ‹è¯•è¶…æ—¶ï¼‰
        const result = await Promise.race([
            resultPromise,
            new Promise(resolve => setTimeout(() => resolve({ type: 'timeout' }), 500))
        ])
        
        printOutput('æœ€ç»ˆç»“æœ:', result)
    }, 10000) // â­ é‡è¦ï¼šç»™æµ‹è¯•è®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´
})
